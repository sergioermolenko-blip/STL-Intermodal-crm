# 📦 Полный Workflow заказов STL Intermodal CRM

## Источники (Industry Standards)
- **INTTRA** - стандарт обмена данными для морских перевозок
- **Flexport** - workflow статусов shipment
- **CMA-CGM, MSC, Maersk** - поля для booking и shipping instructions
- **Fleetbase** (open source) - модульная логистическая платформа

---

## 🔄 Жизненный цикл заказа (Полный Workflow)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    SHIPMENT LIFECYCLE (ПОЛНЫЙ)                              │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│   ====== ЭТАП 1: РАБОТА С КЛИЕНТОМ (входящий запрос) ======                │
│                                                                             │
│   ┌───────────┐                                                             │
│   │  INQUIRY  │  Клиент обратился с запросом                                │
│   │  (Запрос) │  (маршрут, груз, сроки - может быть неполным)              │
│   └─────┬─────┘                                                             │
│         │                                                                   │
│         ▼                                                                   │
│   ====== ЭТАП 2: РАБОТА С ПЕРЕВОЗЧИКАМИ (получение ставок) ======          │
│                                                                             │
│   ┌─────────────────┐                                                       │
│   │ CARRIER_QUOTE   │  Запросили ставки у перевозчиков                      │
│   │ (Запрос ставок) │  (можно отправить нескольким)                         │
│   └────────┬────────┘                                                       │
│            │           ┌───────────────────┐                                │
│            │           │ CarrierQuote #1   │ ← Ответ от перевозчика 1       │
│            ├──────────▶│ CarrierQuote #2   │ ← Ответ от перевозчика 2       │
│            │           │ CarrierQuote #3   │ ← Ответ от перевозчика 3       │
│            │           └───────────────────┘                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │ QUOTES_RECEIVED │  Ставки получены, выбираем лучшую                     │
│   │ (Ставки получ.) │  (сравниваем цены, сроки, условия)                    │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ====== ЭТАП 3: ФОРМИРОВАНИЕ КП ДЛЯ КЛИЕНТА ======                        │
│                                                                             │
│   ┌─────────────────┐                                                       │
│   │ PROPOSAL_DRAFT  │  Доработка заказа, расчёт маржи                       │
│   │ (Подготовка КП) │  (можем предложить несколько вариантов)               │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │ PROPOSAL_SENT   │  КП отправлено клиенту                                │
│   │ (КП отправлено) │  (PDF, email, звонок)                                 │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ├──────────▶ 🔴 DECLINED (Клиент отклонил)                       │
│            │                                                                │
│            ├──────────▶ 🟡 EXPIRED (КП истекло по времени)                  │
│            │                                                                │
│            ▼                                                                │
│   ====== ЭТАП 4: ПОДТВЕРЖДЕНИЕ И БРОНИРОВАНИЕ ======                       │
│                                                                             │
│   ┌─────────────────┐                                                       │
│   │ CLIENT_APPROVED │  Клиент подтвердил КП                                 │
│   │ (Клиент одобрил)│  (выбрал вариант, согласился с ценой)                 │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │    BOOKING      │  Бронирование транспорта у перевозчика                │
│   │   (Букинг)      │  (подтверждаем выбранного перевозчика)                │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ┌─────────────────┐                                                       │
│   │   CONFIRMED     │  Перевозчик подтвердил букинг                         │
│   │ (Подтверждён)   │  (дата, транспорт, ставка зафиксированы)              │
│   └────────┬────────┘                                                       │
│            │                                                                │
│            ▼                                                                │
│   ====== ЭТАП 5: ИСПОЛНЕНИЕ ПЕРЕВОЗКИ ======                               │
│                                                                             │
│   ┌───────────┐   ┌───────────┐   ┌───────────┐   ┌───────────┐            │
│   │ PICKED_UP │──▶│ EXP_CLEAR │──▶│ DEPARTED  │──▶│ IN_TRANSIT│            │
│   └───────────┘   └───────────┘   └───────────┘   └───────────┘            │
│                                                                             │
│   ┌───────────┐   ┌───────────┐   ┌───────────┐                            │
│   │  ARRIVED  │──▶│ IMP_CLEAR │──▶│ DELIVERED │                            │
│   └───────────┘   └───────────┘   └───────────┘                            │
│                                                                             │
│   ====== ЭТАП 6: ФИНАНСОВОЕ ЗАКРЫТИЕ ======                                │
│                                                                             │
│   ┌───────────┐   ┌───────────┐   ┌───────────┐                            │
│   │ INVOICED  │──▶│   PAID    │──▶│  CLOSED   │                            │
│   └───────────┘   └───────────┘   └───────────┘                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 📋 Все статусы заказа

### Этап 1-3: До подтверждения
| Статус | Код | Описание |
|--------|-----|----------|
| **Черновик** | `draft` | Неполный заказ, редактируется |
| **Запрос** | `inquiry` | Получен запрос от клиента |
| **Запрос ставок** | `carrier_quote` | Запросили ставки у перевозчиков |
| **Ставки получены** | `quotes_received` | Получили ответы от перевозчиков |
| **Подготовка КП** | `proposal_draft` | Готовим коммерческое предложение |
| **КП отправлено** | `proposal_sent` | КП отправлено клиенту |
| **Клиент одобрил** | `client_approved` | Клиент подтвердил КП |

### Этап 4: Бронирование
| Статус | Код | Описание |
|--------|-----|----------|
| **Букинг** | `booking` | Бронируем транспорт у перевозчика |
| **Подтверждён** | `confirmed` | Перевозчик подтвердил букинг |

### Этап 5: Исполнение
| Статус | Код | Описание |
|--------|-----|----------|
| **Забран** | `picked_up` | Груз забран у отправителя |
| **Экспорт таможня** | `export_customs` | Проходит экспортную таможню |
| **Отправлен** | `departed` | Покинул страну отправления |
| **В пути** | `in_transit` | Международный транзит |
| **Прибыл** | `arrived` | Прибыл в страну назначения |
| **Импорт таможня** | `import_customs` | Проходит импортную таможню |
| **Частично** | `partial` | Часть груза доставлена |
| **Доставлен** | `delivered` | Весь груз доставлен |

### Этап 6: Финансы
| Статус | Код | Описание |
|--------|-----|----------|
| **Счёт выставлен** | `invoiced` | Счёт отправлен клиенту |
| **Оплачен** | `paid` | Клиент оплатил |
| **Закрыт** | `closed` | Заказ завершён |

### Исключения
| Статус | Код | Описание |
|--------|-----|----------|
| **Истёк** | `expired` | КП/котировка не принята вовремя |
| **Отклонён** | `declined` | Клиент отклонил КП |
| **Отменён** | `cancelled` | Заказ отменён |
| **Приостановлен** | `hold` | Временно приостановлен |
| **Проблема** | `problem` | Требует внимания |
| **Возврат** | `returned` | Груз возвращён |
| **Утерян** | `lost` | Груз утерян |

---

## 🎯 Edge Cases (Особые случаи)

### 1. Черновик / Неполный заказ
Клиент позвонил, но не знает точные детали → создаём `draft`, заполняем частично.

### 2. Неизвестный тип транспорта
Клиент не знает какой транспорт лучше → поле `transportMode = TBD`.

### 3. Несколько котировок от перевозчиков
Запрашиваем у 3-5 перевозчиков → выбираем лучшую → формируем КП с маржой.

### 4. Несколько вариантов для клиента
Можем предложить: море (дешевле, дольше) vs авиа (дороже, быстрее).

### 5. Частичная доставка
Часть груза доставлена, часть задержалась → статус `partial`.

### 6. Изменение после подтверждения
Клиент хочет изменить дату → создаём Amendment, требуется повторное подтверждение.

### 7. Отмена на любом этапе
Всегда можно перейти в `cancelled` или `hold`.

---

## ✅ Разрешённые переходы статусов

```javascript
const allowedTransitions = {
  'draft':           ['inquiry', 'cancelled'],
  'inquiry':         ['carrier_quote', 'cancelled'],
  'carrier_quote':   ['quotes_received', 'cancelled'],
  'quotes_received': ['proposal_draft', 'cancelled'],
  'proposal_draft':  ['proposal_sent', 'cancelled'],
  'proposal_sent':   ['client_approved', 'declined', 'expired'],
  'client_approved': ['booking', 'cancelled'],
  'booking':         ['confirmed', 'cancelled'],
  'confirmed':       ['picked_up', 'cancelled', 'hold'],
  'picked_up':       ['export_customs', 'departed', 'in_transit'],
  'export_customs':  ['departed', 'hold', 'problem'],
  'departed':        ['in_transit'],
  'in_transit':      ['arrived', 'hold', 'problem'],
  'arrived':         ['import_customs', 'delivered'],
  'import_customs':  ['delivered', 'partial', 'hold', 'problem'],
  'partial':         ['delivered', 'hold'],
  'delivered':       ['invoiced', 'closed'],
  'invoiced':        ['paid'],
  'paid':            ['closed'],
  'hold':            ['*previous*', 'cancelled'],
  'problem':         ['*previous*', 'cancelled', 'returned', 'lost']
};
```

---

## 🎨 Цвета статусов (CSS)

```css
.status-draft          { background: #9E9E9E; }  /* Серый */
.status-inquiry        { background: #2196F3; }  /* Синий */
.status-carrier_quote  { background: #03A9F4; }  /* Голубой */
.status-quotes_received{ background: #00BCD4; }  /* Циан */
.status-proposal_draft { background: #009688; }  /* Бирюзовый */
.status-proposal_sent  { background: #FF9800; }  /* Оранжевый */
.status-client_approved{ background: #8BC34A; }  /* Салатовый */
.status-booking        { background: #CDDC39; }  /* Лайм */
.status-confirmed      { background: #4CAF50; }  /* Зелёный */
.status-picked_up      { background: #4CAF50; }  /* Зелёный */
.status-in_transit     { background: #3F51B5; }  /* Индиго */
.status-delivered      { background: #4CAF50; }  /* Зелёный */
.status-invoiced       { background: #FFC107; }  /* Жёлтый */
.status-paid           { background: #8BC34A; }  /* Салатовый */
.status-closed         { background: #607D8B; }  /* Серо-синий */
.status-cancelled      { background: #F44336; }  /* Красный */
.status-problem        { background: #F44336; }  /* Красный */
```
